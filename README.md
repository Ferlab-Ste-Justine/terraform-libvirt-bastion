# About

This package is a terraform module to provision a bastion on kvm.

The package takes an public external ssh key to login to the bastion and an internal ssh key pair that will be setup on the bastion so that a user can login to other machines from the bastion.

The bastion provision some packages as part of its cloud-init logic: ansible, netaddr, jq

# Usage

## Variables

The module takes the following variables as input:

- **name**: Name of the bastion vm
- **vcpus**: Number of vcpus to assign to the bastion
- **memory**: Amount of memory to assign to the bastion in MiB
- **volume_id**: Id of the disk volume to attach to the vm
- **libvirt_network**: Parameters to connect to a libvirt network if you opt for that instead of macvtap interfaces. In has the following keys:
  - **ip**: Ip of the vm.
  - **mac**: Mac address of the vm. If none is passed, a random one will be generated.
  - **network_id**: Id (ie, uuid) of the libvirt network to connect to (in which case **network_name** should be an empty string).
  - **network_name**: Name of the libvirt network to connect to (in which case **network_id** should be an empty string).
- **macvtap_interfaces**: List of macvtap interfaces to connect the vm to if you opt for macvtap interfaces instead of a libvirt network. Each entry in the list is a map with the following keys:
  - **interface**: Host network interface that you plan to connect your macvtap interface with.
  - **prefix_length**: Length of the network prefix for the network the interface will be connected to. For a **192.168.1.0/24** for example, this would be **24**.
  - **ip**: Ip associated with the macvtap interface. 
  - **mac**: Mac address associated with the macvtap interface
  - **gateway**: Ip of the network's gateway for the network the interface will be connected to.
  - **dns_servers**: Dns servers for the network the interface will be connected to. If there aren't dns servers setup for the network your vm will connect to, the ip of external dns servers accessible accessible from the network will work as well.
- **cloud_init_volume_pool**: Name of the volume pool that will contain the cloud-init volume of the vm.
- **cloud_init_volume_name**: Name of the cloud-init volume that will be generated by the module for your vm. If left empty, it will default to ``<vm name>-cloud-init.iso``.
- **admin_user**: Username of the default sudo user in the image. Defaults to **ubuntu**.
- **admin_user_password**: Optional password for the default sudo user of the image. Note that this will not enable ssh password connections, but it will allow you to log into the vm from the host using the **virsh console** command.
- **ssh_external_public_key**: Public part of the ssh key that will be used to login as the admin on the bastion
- **ssh_internal_private_key**: Private part of the ssh keypair that the bastion will use to ssh on instances
- **ssh_internal_public_key**: Public part of the ssh keypair that the bastion will use to ssh on instances

## Example

Here is an example of how the bastion module might be used:

```
data "local_file" "bastion_ssh_external_public_key" {
  filename = pathexpand("~/bastion-external/id_rsa.pub")
}

data "local_file" "bastion_ssh_internal_public_key" {
  filename = pathexpand("~/bastion-internal/id_rsa.pub")
}

data "local_file" "bastion_ssh_internal_private_key" {
  filename = pathexpand("~/bastion-internal/id_rsa")
}


resource "libvirt_volume" "bastion" {
  name             = "bastion"
  pool             = "bastion"
  //10 GiB
  size             = 10 * 1024 * 1024 * 1024
  base_volume_pool = "os"
  base_volume_name = "ubuntu"
  format = "qcow2"
}

module "bastion_alpha" {
  source = "git::https://github.com/Ferlab-Ste-Justine/kvm-bastion"
  name = "bastion"
  vcpus = 1
  memory = 4096
  volume_id = libvirt_volume.bastion.id
  network_id = var.bastion_network_id
  macvtap_interface = var.bastion_macvtap_interface
  macvtap_subnet_prefix_length = var.bastion_macvtap_subnet_prefix_length
  macvtap_gateway_ip = var.bastion_macvtap_gateway_ip
  macvtap_dns_servers = var.bastion_dns_servers
  ip = var.bastion_ip
  mac = var.bastion_mac
  cloud_init_volume_pool = "cloud-init-vols"
  ssh_internal_public_key = chomp(data.local_file.bastion_ssh_internal_public_key.content)
  ssh_internal_private_key = chomp(data.local_file.bastion_ssh_internal_private_key.content)
  ssh_external_public_key = chomp(data.local_file.bastion_ssh_external_public_key.content)
  admin_user_password = "yes"
}
```

For networking elaboration and gotcha, see the following which is the same as this project: https://github.com/Ferlab-Ste-Justine/kvm-etcd-server#example
